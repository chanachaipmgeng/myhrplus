<div class="profile-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Personal Profile</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loading; else profileContent" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>

      <ng-template #profileContent>
        <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
          <div class="profile-picture-section">
            <div class="picture-container">
              <img *ngIf="profilePicture" [src]="profilePicture" alt="Profile Picture" class="profile-picture">
              <div *ngIf="!profilePicture" class="picture-placeholder">
                <mat-icon>person</mat-icon>
              </div>
              <input type="file" #fileInput accept="image/*" (change)="onPictureSelected($event)" style="display: none;">
              <button mat-icon-button (click)="fileInput.click()" matTooltip="Change Picture">
                <mat-icon>camera_alt</mat-icon>
              </button>
            </div>
          </div>

          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Full Name (Thai) *</mat-label>
              <input matInput formControlName="tfullname" required>
              <mat-icon matPrefix>badge</mat-icon>
              <mat-error *ngIf="profileForm.get('tfullname')?.hasError('required')">
                Full name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Full Name (English)</mat-label>
              <input matInput formControlName="efullname">
              <mat-icon matPrefix>badge</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email">
              <mat-icon matPrefix>email</mat-icon>
              <mat-error *ngIf="profileForm.get('email')?.hasError('email')">
                Invalid email format
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Phone</mat-label>
              <input matInput formControlName="phone">
              <mat-icon matPrefix>phone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Mobile</mat-label>
              <input matInput formControlName="mobile">
              <mat-icon matPrefix>smartphone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Birth Date</mat-label>
              <input matInput [matDatepicker]="birthDatePicker" formControlName="birthDate">
              <mat-datepicker-toggle matSuffix [for]="birthDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #birthDatePicker></mat-datepicker>
              <mat-icon matPrefix>calendar_today</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Gender</mat-label>
              <mat-select formControlName="gender">
                <mat-option value="M">Male</mat-option>
                <mat-option value="F">Female</mat-option>
                <mat-option value="O">Other</mat-option>
              </mat-select>
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nationality</mat-label>
              <input matInput formControlName="nationality">
              <mat-icon matPrefix>public</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Religion</mat-label>
              <input matInput formControlName="religion">
              <mat-icon matPrefix>place_of_worship</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Marital Status</mat-label>
              <mat-select formControlName="maritalStatus">
                <mat-option value="S">Single</mat-option>
                <mat-option value="M">Married</mat-option>
                <mat-option value="D">Divorced</mat-option>
                <mat-option value="W">Widowed</mat-option>
              </mat-select>
              <mat-icon matPrefix>favorite</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>ID Card</mat-label>
              <input matInput formControlName="idCard">
              <mat-icon matPrefix>credit_card</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>ID Card Expiry Date</mat-label>
              <input matInput [matDatepicker]="idCardExpiryPicker" formControlName="idCardExpiryDate">
              <mat-datepicker-toggle matSuffix [for]="idCardExpiryPicker"></mat-datepicker-toggle>
              <mat-datepicker #idCardExpiryPicker></mat-datepicker>
              <mat-icon matPrefix>event</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Passport No</mat-label>
              <input matInput formControlName="passportNo">
              <mat-icon matPrefix>card_membership</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Passport Expiry Date</mat-label>
              <input matInput [matDatepicker]="passportExpiryPicker" formControlName="passportExpiryDate">
              <mat-datepicker-toggle matSuffix [for]="passportExpiryPicker"></mat-datepicker-toggle>
              <mat-datepicker #passportExpiryPicker></mat-datepicker>
              <mat-icon matPrefix>event</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Emergency Contact</mat-label>
              <input matInput formControlName="emergencyContact">
              <mat-icon matPrefix>contact_emergency</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Emergency Phone</mat-label>
              <input matInput formControlName="emergencyPhone">
              <mat-icon matPrefix>phone</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading || profileForm.invalid">
              <mat-spinner diameter="20" *ngIf="loading" class="inline-spinner"></mat-spinner>
              <span *ngIf="!loading">Update Profile</span>
              <span *ngIf="loading">Updating...</span>
            </button>
          </div>
        </form>
      </ng-template>
    </mat-card-content>
  </mat-card>

  <mat-card class="mt-3">
    <mat-card-header>
      <mat-card-title>Change Password</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Current Password</mat-label>
          <input matInput type="password" formControlName="currentPassword" required>
          <mat-icon matPrefix>lock</mat-icon>
          <mat-error *ngIf="passwordForm.get('currentPassword')?.hasError('required')">
            Current password is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>New Password</mat-label>
          <input matInput type="password" formControlName="newPassword" required>
          <mat-icon matPrefix>lock_outline</mat-icon>
          <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('required')">
            New password is required
          </mat-error>
          <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('minlength')">
            Password must be at least 6 characters
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm New Password</mat-label>
          <input matInput type="password" formControlName="confirmPassword" required>
          <mat-icon matPrefix>lock_outline</mat-icon>
          <mat-error *ngIf="passwordForm.get('confirmPassword')?.hasError('required')">
            Please confirm your password
          </mat-error>
          <mat-error *ngIf="passwordForm.hasError('passwordMismatch')">
            Passwords do not match
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="loading || passwordForm.invalid">
            <mat-spinner diameter="20" *ngIf="loading" class="inline-spinner"></mat-spinner>
            <span *ngIf="!loading">Change Password</span>
            <span *ngIf="loading">Changing...</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
