<div class="goal-setting-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Goal Setting</mat-card-title>
      <div class="header-controls">
        <mat-form-field appearance="outline">
          <mat-label>Year</mat-label>
          <mat-select [(ngModel)]="selectedYear" (selectionChange)="loadAppraisalsForYear()">
            <mat-option *ngFor="let year of getYearOptions()" [value]="year">
              {{ year }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-header>
    <mat-card-content>
      <div class="goals-header">
        <h3>Appraisal Goals</h3>
        <div class="weight-info">
          <span>Total Weight: <strong>{{ calculateTotalWeight() }}%</strong></span>
        </div>
        <button mat-raised-button color="primary" (click)="addGoal()">
          <mat-icon>add</mat-icon>
          Add Goal
        </button>
      </div>

      <div *ngIf="loading; else goalsContent" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>

      <ng-template #goalsContent>
        <form [formGroup]="goalsForm">
          <div formArrayName="goals">
            <div *ngFor="let goal of goalsArray.controls; let i = index" [formGroupName]="i" class="goal-item">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>Goal {{ i + 1 }}</mat-card-title>
                  <div class="goal-actions">
                    <button mat-icon-button color="warn" (click)="removeGoal(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </mat-card-header>
                <mat-card-content>
                  <div class="goal-form-grid">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Goal Title</mat-label>
                      <input matInput formControlName="goalTitle">
                      <mat-error *ngIf="goal.get('goalTitle')?.hasError('required')">
                        Goal title is required
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Description</mat-label>
                      <textarea matInput formControlName="goalDescription" rows="3"></textarea>
                      <mat-error *ngIf="goal.get('goalDescription')?.hasError('required')">
                        Description is required
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Target Value</mat-label>
                      <input matInput type="number" formControlName="targetValue">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Actual Value</mat-label>
                      <input matInput type="number" formControlName="actualValue">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Weight (%)</mat-label>
                      <input matInput type="number" formControlName="weight" min="0" max="100">
                      <mat-error *ngIf="goal.get('weight')?.hasError('required')">
                        Weight is required
                      </mat-error>
                      <mat-error *ngIf="goal.get('weight')?.hasError('min') || goal.get('weight')?.hasError('max')">
                        Weight must be between 0 and 100
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Score</mat-label>
                      <input matInput type="number" formControlName="score">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Category</mat-label>
                      <input matInput formControlName="category">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Due Date</mat-label>
                      <input matInput [matDatepicker]="duePicker" formControlName="dueDate">
                      <mat-datepicker-toggle matSuffix [for]="duePicker"></mat-datepicker-toggle>
                      <mat-datepicker #duePicker></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <div class="progress-section" *ngIf="goal.get('targetValue')?.value && goal.get('actualValue')?.value">
                    <div class="progress-info">
                      <span>Progress: {{ calculateProgress(goal.value) | number:'1.0-0' }}%</span>
                    </div>
                    <mat-progress-bar 
                      mode="determinate" 
                      [value]="calculateProgress(goal.value)">
                    </mat-progress-bar>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <div class="goals-actions" *ngIf="goalsArray.length > 0">
            <button mat-raised-button color="primary" (click)="saveGoals()" [disabled]="loading || goalsForm.invalid">
              <mat-spinner diameter="20" *ngIf="loading" class="inline-spinner"></mat-spinner>
              <span *ngIf="!loading">Save Goals</span>
              <span *ngIf="loading">Saving...</span>
            </button>
          </div>

          <div class="no-goals" *ngIf="goalsArray.length === 0">
            <mat-icon>flag</mat-icon>
            <p>No goals added yet. Click "Add Goal" to create one.</p>
          </div>
        </form>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>

