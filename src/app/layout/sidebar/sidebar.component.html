<div class="two-layer-sidebar h-full flex" [class.dark]="isDarkMode">
  <!-- Left Icon Bar - Module Icons -->
  <div class="icon-bar flex flex-col items-center py-4 border-r transition-colors duration-300">
    <!-- Logo -->
    <div class="mb-6">
      <a routerLink="/home"
         class="logo-container w-12 h-12 rounded-xl flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 cursor-pointer"
         [attr.aria-label]="'Home'"
         role="button"
         tabindex="0">
        <span class="text-white text-xl font-bold">H</span>
      </a>
    </div>

    <!-- Module Icons -->
    <div class="flex flex-col gap-3 flex-1 w-full px-2">
      <a *ngFor="let module of mainModules"
         [routerLink]="getModuleHomeRoute(module.id)"
         routerLinkActive="active"
         [routerLinkActiveOptions]="{exact: false}"
         [class.active]="selectedModule === module.id"
         [attr.aria-label]="module.name"
         [attr.aria-current]="selectedModule === module.id ? 'true' : 'false'"
         [attr.title]="module.name"
         class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl transition-all duration-300 relative group">
        <span [class]="module.iconCss" class="text-xl transition-colors duration-300"></span>
        <!-- Active Indicator -->
        <span *ngIf="selectedModule === module.id" class="active-indicator"></span>
        <!-- Tooltip -->
        <span class="module-tooltip">{{ module.name }}</span>
      </a>
    </div>
  </div>

  <!-- Right Menu Panel - Module Menu -->
  <div class="menu-panel flex-1 flex flex-col overflow-hidden transition-colors duration-300">
    <div class="p-5 flex-1 overflow-y-auto">
      <!-- Module Header with Search -->
      <div class="mb-6" *ngIf="selectedModuleData">
        <div class="flex items-center justify-between mb-4">
          <h2 class="module-title text-2xl font-bold thai-text transition-colors duration-300">
            {{ selectedModuleData.name }}
          </h2>
        </div>

        <!-- Search Box -->
        <div class="search-container mb-4 relative" *ngIf="selectedModuleData.menuItems.length > 3">
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            [placeholder]="'ค้นหาเมนู...'"
            class="search-input w-full px-4 py-2 rounded-lg border transition-all duration-300 focus:outline-none focus:ring-2"
            [attr.aria-label]="'ค้นหาเมนู'">
          <app-icon name="search" size="sm" color="text-gray-500 dark:text-gray-400 theme-gemini:text-white/70" class="search-icon absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></app-icon>
          <button
            *ngIf="searchQuery"
            (click)="clearSearch()"
            class="clear-search-btn"
            [attr.aria-label]="'ล้างการค้นหา'"
            type="button">
            <app-icon name="close" size="sm" color="text-gray-500 dark:text-gray-400 theme-gemini:text-white/70"></app-icon>
          </button>
        </div>

        <div class="module-divider h-px transition-colors duration-300 mb-4"></div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="skeleton-loader" *ngFor="let item of [1,2,3,4,5]">
          <div class="skeleton-icon"></div>
          <div class="skeleton-text"></div>
        </div>
      </div>

      <!-- Module Menu Items -->
      <ejs-listview
        *ngIf="!isLoading && selectedModuleData && filteredMenuItems && filteredMenuItems.length > 0"
        #listview
        [dataSource]="filteredMenuItems"
        [fields]="listViewFields"
        [showIcon]="true"
        [showCheckBox]="false"
        (select)="onMenuItemSelect($event)"
        class="syncfusion-module-menu">
      </ejs-listview>

      <!-- Search No Results -->
      <div *ngIf="!isLoading && selectedModuleData && searchQuery && filteredMenuItems.length === 0"
           class="empty-menu-state flex flex-col items-center justify-center py-12">
        <app-icon name="search_off" size="xl" color="text-gray-400 dark:text-gray-600 theme-gemini:text-white/60" class="mb-4 opacity-50"></app-icon>
        <p class="empty-text thai-text text-center">ไม่พบเมนูที่ค้นหา</p>
        <button
          (click)="clearSearch()"
          class="mt-4 px-4 py-2 rounded-lg transition-all duration-300"
          type="button">
          ล้างการค้นหา
        </button>
      </div>

      <!-- Empty State - No Menu Items -->
      <div *ngIf="!isLoading && selectedModuleData && !searchQuery && selectedModuleData.menuItems.length === 0"
           class="empty-menu-state flex flex-col items-center justify-center py-12">
        <app-icon name="folder_open" size="xl" color="text-gray-400 dark:text-gray-600 theme-gemini:text-white/60" class="mb-4 opacity-50"></app-icon>
        <p class="empty-text thai-text text-center">ไม่มีเมนูในโมดูลนี้</p>
      </div>

      <!-- Empty State - No Module Selected -->
      <div *ngIf="!selectedModuleData" class="empty-state flex flex-col items-center justify-center h-full py-12">
        <app-icon name="folder" size="xl" color="text-gray-400 dark:text-gray-600 theme-gemini:text-white/60" class="mb-4 opacity-50"></app-icon>
        <p class="empty-text thai-text text-center">เลือกโมดูลเพื่อดูเมนู</p>
      </div>
    </div>

    <!-- User Avatar Section - Bottom of Menu Panel -->
    <div class="user-avatar-section border-t transition-colors duration-300" *ngIf="currentUser" #userMenuContainer>
      <div class="p-4">
        <div class="user-info-container flex items-center gap-3 cursor-pointer group"
             (click)="toggleUserMenu()"
             (keydown.enter)="toggleUserMenu()"
             (keydown.space)="toggleUserMenu(); $event.preventDefault()"
             [attr.aria-label]="'เมนูผู้ใช้งาน'"
             [attr.aria-expanded]="showUserMenu"
             role="button"
             tabindex="0">
          <!-- Avatar -->
          <div class="user-avatar relative flex-shrink-0">
            <div class="avatar-circle w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-sm transition-all duration-300 group-hover:scale-110"
                 [style.background]="getAvatarColor()">
              <img *ngIf="getAvatarUrl()"
                   [src]="getAvatarUrl()"
                   [alt]="getUserDisplayName()"
                   class="w-full h-full rounded-full object-cover"
                   (load)="onAvatarImageLoad()"
                   (error)="onAvatarImageError($event)">
              <span class="avatar-initials" [class.hidden]="avatarImageLoaded && getAvatarUrl()">
                {{ getInitials() }}
              </span>
            </div>
            <!-- Online Status Indicator -->
            <span class="status-indicator"></span>
          </div>

          <!-- User Info -->
          <div class="user-info flex-1 min-w-0">
            <div class="user-name text-sm font-semibold thai-text transition-colors duration-300 truncate">
              {{ getUserDisplayName() }}
            </div>
            <div class="user-role text-xs transition-colors duration-300 truncate" *ngIf="getUserRole()">
              {{ getUserRole() }}
            </div>
          </div>

          <!-- Dropdown Icon -->
          <div class="dropdown-icon transition-transform duration-300" [class.rotated]="showUserMenu">
            <span class="e-icons e-chevron-down"></span>
          </div>
        </div>

        <!-- User Menu Dropdown -->
        <div class="user-menu-dropdown"
             *ngIf="showUserMenu"
             @slideDown>
          <div class="user-menu-items">
            <a routerLink="/personal/profile"
               class="user-menu-item"
               (click)="showUserMenu = false"
               [attr.aria-label]="'โปรไฟล์'">
              <app-icon name="person" size="sm" color="text-gray-600 dark:text-gray-400 theme-gemini:text-white/70"></app-icon>
              <span class="thai-text">โปรไฟล์</span>
            </a>
            <a routerLink="/setting/home"
               class="user-menu-item"
               (click)="showUserMenu = false"
               [attr.aria-label]="'ตั้งค่า'">
              <app-icon name="settings" size="sm" color="text-gray-600 dark:text-gray-400 theme-gemini:text-white/70"></app-icon>
              <span class="thai-text">ตั้งค่า</span>
            </a>
            <div class="user-menu-divider"></div>
            <button
              class="user-menu-item text-red-500 dark:text-red-400"
              (click)="logout()"
              [attr.aria-label]="'ออกจากระบบ'"
              type="button">
              <app-icon name="logout" size="sm" color="text-red-500 dark:text-red-400"></app-icon>
              <span class="thai-text">ออกจากระบบ</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
