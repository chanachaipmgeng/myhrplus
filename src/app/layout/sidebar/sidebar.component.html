<div class="two-layer-sidebar h-full flex animate-fade-in" [class.dark]="isDarkMode">
  <!-- Left Icon Bar - Module Icons -->
  <div class="icon-bar flex flex-col items-center py-4 border-r
              transition-all duration-300 ease-in-out
              bg-white/5 dark:bg-gray-900/20 theme-gemini:bg-gray-900/30
              backdrop-blur-sm">
    <!-- Logo -->
    <div class="mb-6">
      <a routerLink="/home"
         class="logo-container w-12 h-12 rounded-xl flex items-center justify-center shadow-lg
                transition-all duration-300 ease-out
                hover:scale-110 hover:shadow-xl hover:-translate-y-1
                active:scale-95
                bg-white/10 dark:bg-gray-900/20 theme-gemini:bg-gray-900/30
                backdrop-blur-sm
                border border-white/20 dark:border-gray-700/20 theme-gemini:border-primary/30
                cursor-pointer
                group relative overflow-hidden
                animate-gemini-pulse">
        <!-- Shimmer Effect -->
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent
                    -translate-x-full group-hover:translate-x-full
                    transition-transform duration-1000 ease-in-out"></div>
        <img [src]="getLogoPath()"
             [alt]="'layout.sidebar.appLogo' | translate"
             class="w-10 h-10 object-contain relative z-10
                    group-hover:scale-110 transition-transform duration-300" />
      </a>
    </div>

    <!-- Navigation Icons (Rail) -->
    <div class="flex flex-col gap-3 flex-1 w-full px-2">
      <!-- Level 2 Items - Show Admin Level 2 items directly (no Level 1 selection) -->
      <ng-container *ngIf="level2Items.length > 0">

        <!-- Level 2 Items (Admin Level 2 items shown directly) -->
        <button *ngFor="let level2Item of level2Items; let i = index"
                (click)="selectLevel2Item(level2Item, selectedNavigationItem)"
                [class.active]="selectedLevel2Item === level2Item"
                [attr.aria-label]="translateLabel(level2Item.label, 'admin', 2)"
                [attr.aria-current]="selectedLevel2Item === level2Item ? 'true' : 'false'"
                [attr.title]="translateLabel(level2Item.label, 'admin', 2)"
                [style.animation-delay.ms]="i * 50"
                class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                       transition-all duration-300 ease-out
                       hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                       active:scale-95
                       relative group
                       animate-fade-in
                       cursor-pointer
                       border-0 bg-transparent">
          <!-- Hover Background -->
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <!-- Icon -->
          <span class="material-icons text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90">
            {{ level2Item.icon || 'folder' }}
          </span>
          <!-- Active Indicator -->
          <span *ngIf="selectedLevel2Item === level2Item"
                class="active-indicator
                       animate-pulse"></span>
          <!-- Badge -->
          <span *ngIf="level2Item.badge"
                class="absolute top-0 right-0 w-5 h-5 rounded-full
                       flex items-center justify-center text-xs font-bold
                       bg-red-500 text-white
                       transform translate-x-1 -translate-y-1
                       z-20">{{ level2Item.badge }}</span>
          <!-- Tooltip -->
          <span class="module-tooltip
                       animate-fade-in
                       [animation-delay:100ms]">{{ translateLabel(level2Item.label, 'admin', 2) }}</span>
        </button>
      </ng-container>


      <!-- Fallback to legacy modules if navigationItems is empty -->
      <ng-container *ngIf="navigationItems.length === 0">
        <a *ngFor="let module of mainModules; let i = index"
           [routerLink]="getModuleHomeRoute(module.id)"
           routerLinkActive="active"
           [routerLinkActiveOptions]="{exact: false}"
           [class.active]="selectedModule === module.id"
           [attr.aria-label]="module.name"
           [attr.aria-current]="selectedModule === module.id ? 'true' : 'false'"
           [attr.title]="module.name"
           [style.animation-delay.ms]="i * 50"
           class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                  transition-all duration-300 ease-out
                  hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                  active:scale-95
                  relative group
                  animate-fade-in">
          <!-- Hover Background -->
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <span *ngIf="module.iconCss"
                [class]="module.iconCss"
                class="text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90"></span>
          <span *ngIf="!module.iconCss"
                class="text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90
                       e-icons e-folder"></span>
          <!-- Active Indicator -->
          <span *ngIf="selectedModule === module.id"
                class="active-indicator
                       animate-pulse"></span>
          <!-- Tooltip -->
          <span class="module-tooltip
                       animate-fade-in
                       [animation-delay:100ms]">{{ module.name }}</span>
        </a>
      </ng-container>
    </div>
  </div>

  <!-- Right Menu Panel - Module Menu -->
  <div class="menu-panel flex-1 flex flex-col overflow-hidden
              transition-all duration-300 ease-in-out
              bg-gradient-to-br from-white/5 via-white/10 to-white/5
              dark:from-gray-900/20 dark:via-gray-900/30 dark:to-gray-900/20
              theme-gemini:from-gray-900/30 theme-gemini:via-gray-900/40 theme-gemini:to-gray-900/30
              backdrop-blur-md border-l border-white/10 dark:border-gray-800/30 theme-gemini:border-white/20">
    <div class="p-6 flex-1 overflow-y-auto">
      <!-- Header Section -->
      <div class="mb-6">
        <!-- Module Title -->
        <div class="mb-4" *ngIf="selectedLevel2Item || selectedNavigationItem">
          <h2 class="module-title text-xl font-bold thai-text
                     text-gray-800 dark:text-gray-100 theme-gemini:text-white
                     mb-1 transition-colors duration-300">
            {{ translateLabel((selectedLevel2Item ? selectedLevel2Item.label : (selectedNavigationItem ? selectedNavigationItem.label : '')) || '', 'admin', selectedLevel2Item ? 2 : 1) || ('layout.sidebar.menu' | translate) }}
          </h2>
          <p class="text-xs text-gray-500 dark:text-gray-400 theme-gemini:text-white/70" *ngIf="selectedNavigationItem">
            {{ translateLabel(selectedNavigationItem.label, selectedNavigationItem.id, 1) }}
          </p>
        </div>

        <!-- Back Button (when in Level 3+) -->
        <div class="mb-4" *ngIf="selectedNavigationItem?.id === 'admin' && selectedLevel3Item">
          <button (click)="goBackToLevel2()"
                  class="back-button flex items-center gap-2 px-4 py-2 rounded-lg
                         transition-all duration-200 ease-out
                         bg-white/20 dark:bg-gray-800/30 theme-gemini:bg-white/10
                         hover:bg-white/30 dark:hover:bg-gray-700/40 theme-gemini:hover:bg-white/20
                         hover:scale-[1.02] active:scale-[0.98]
                         text-sm font-medium
                         text-gray-700 dark:text-gray-300 theme-gemini:text-white/90
                         cursor-pointer border-0
                         backdrop-blur-sm
                         border border-white/30 dark:border-gray-700/30 theme-gemini:border-white/20">
            <span class="material-icons text-base">arrow_back</span>
            <span class="thai-text">{{ 'layout.sidebar.back' | translate }}</span>
          </button>
        </div>

        <!-- Search Box -->
        <div class="search-container mb-4 relative animate-fade-in" *ngIf="navigationChildren.length > 3 || filteredMenuItems.length > 3">
          <app-glass-input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            [placeholder]="'layout.sidebar.searchMenuPlaceholder' | translate"
            [ariaLabel]="'layout.sidebar.searchMenu' | translate"
            customClass="w-full pr-11">
            <ng-container *ngIf="searchQuery">
              <button
                (click)="clearSearch()"
                class="absolute right-2 top-1/2 -translate-y-1/2
                       w-8 h-8 flex items-center justify-center rounded-lg
                       hover:bg-gray-200/50 dark:hover:bg-gray-700/50 theme-gemini:hover:bg-white/20
                       hover:scale-110 active:scale-95
                       transition-all duration-200 ease-out"
                [attr.aria-label]="'layout.sidebar.clearSearch' | translate"
                type="button">
                <app-icon name="close" size="sm"
                          color="text-gray-500 dark:text-gray-400 theme-gemini:text-white/70
                                 hover:text-red-500 dark:hover:text-red-400
                                 transition-colors duration-200"></app-icon>
              </button>
            </ng-container>
          </app-glass-input>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="space-y-3">
        <app-skeleton-loader
          [type]="'list'"
          [rows]="5">
        </app-skeleton-loader>
      </div>

      <!-- Module Menu Items - Using Nested Accordion -->
      <!-- Show Level 3 items when Level 2 is selected (Level 4 as children) -->
      <ng-container *ngIf="!isLoading && navigationChildren.length > 0">
        <div class="nested-menu-container
                    bg-white/20 dark:bg-gray-800/20 theme-gemini:bg-white/5
                    backdrop-blur-sm rounded-xl
                    border border-white/20 dark:border-gray-700/20 theme-gemini:border-white/10">
          <app-nested-menu-accordion
            [items]="navigationChildren"
            [activeRoute]="activeRoute"
            [level]="3"
            [expandedItems]="expandedLevel3Items"
            [navId]="'admin'"
            (itemClick)="onAccordionItemClick($event)"
            (toggleExpand)="onAccordionToggleExpand($event)">
          </app-nested-menu-accordion>
        </div>
      </ng-container>

      <!-- Fallback to Legacy ListView (if no navigation children) -->
      <ejs-listview
        *ngIf="!isLoading && navigationChildren.length === 0 && filteredMenuItems && filteredMenuItems.length > 0"
        #listview
        [dataSource]="filteredMenuItems"
        [fields]="listViewFields"
        [showIcon]="true"
        [showCheckBox]="false"
        (select)="onMenuItemSelect($event)"
        class="syncfusion-module-menu">
      </ejs-listview>

      <!-- Search No Results -->
      <app-empty-state
        *ngIf="!isLoading && searchQuery && navigationChildren.length === 0 && filteredMenuItems.length === 0"
        [icon]="'search_off'"
        [title]="'layout.sidebar.noSearchResults' | translate"
        [description]="'layout.sidebar.tryDifferentSearch' | translate">
        <app-glass-button
          variant="secondary"
          size="sm"
          [ariaLabel]="'layout.sidebar.clearSearch' | translate"
          (clicked)="clearSearch()">
          {{ 'layout.sidebar.clearSearch' | translate }}
        </app-glass-button>
      </app-empty-state>

      <!-- Empty State - No Menu Items -->
      <app-empty-state
        *ngIf="!isLoading && !searchQuery && navigationChildren.length === 0 && filteredMenuItems.length === 0"
        [icon]="'folder_open'"
        [title]="'layout.sidebar.noMenuInMode' | translate">
      </app-empty-state>
    </div>
  </div>
</div>












