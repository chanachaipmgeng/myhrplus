<div class="two-layer-sidebar h-full flex animate-fade-in" [class.dark]="isDarkMode">
  <!-- Left Icon Bar - Module Icons -->
  <div class="icon-bar flex flex-col items-center py-4 border-r
              transition-all duration-300 ease-in-out
              bg-white/5 dark:bg-gray-900/20 theme-gemini:bg-gray-900/30
              backdrop-blur-sm">
    <!-- Logo -->
    <div class="mb-6">
      <a routerLink="/portal"
         class="logo-container w-12 h-12 rounded-xl flex items-center justify-center shadow-lg
                transition-all duration-300 ease-out
                hover:scale-110 hover:shadow-xl hover:-translate-y-1
                active:scale-95
                bg-gradient-to-br from-blue-500 to-indigo-600
                dark:from-blue-600 dark:to-indigo-700
                cursor-pointer
                group relative overflow-hidden
                animate-gemini-pulse">
        <!-- Shimmer Effect -->
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent
                    -translate-x-full group-hover:translate-x-full
                    transition-transform duration-1000 ease-in-out"></div>
        <span class="text-white text-xl font-bold relative z-10
                      group-hover:scale-110 transition-transform duration-300">H</span>
      </a>
    </div>

    <!-- Navigation Icons (Rail) -->
    <div class="flex flex-col gap-3 flex-1 w-full px-2">
      <!-- Level 2 Items - Show when Level 1 is selected -->
      <ng-container *ngIf="selectedNavigationItem && level2Items.length > 0">
        <!-- Home Button -->
        <button (click)="goToHome()"
                class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                       transition-all duration-300 ease-out
                       hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                       active:scale-95
                       relative group
                       animate-fade-in
                       cursor-pointer
                       border-0 bg-transparent
                       mb-2">
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <span class="material-icons text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90">
            home
          </span>
          <span class="module-tooltip animate-fade-in">{{ 'layout.sidebar.home' | translate }}</span>
        </button>

        <!-- Level 2 Items (children of selected Level 1) -->
        <button *ngFor="let level2Item of level2Items; let i = index"
                (click)="selectLevel2Item(level2Item, selectedNavigationItem)"
                [class.active]="selectedLevel2Item === level2Item"
                [attr.aria-label]="translateLabel(level2Item.label, selectedNavigationItem ? selectedNavigationItem.id : undefined, 2)"
                [attr.aria-current]="selectedLevel2Item === level2Item ? 'true' : 'false'"
                [attr.title]="translateLabel(level2Item.label, selectedNavigationItem ? selectedNavigationItem.id : undefined, 2)"
                [style.animation-delay.ms]="i * 50"
                class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                       transition-all duration-300 ease-out
                       hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                       active:scale-95
                       relative group
                       animate-fade-in
                       cursor-pointer
                       border-0 bg-transparent">
          <!-- Hover Background -->
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <!-- Icon -->
          <span class="material-icons text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90">
            {{ level2Item.icon || 'folder' }}
          </span>
          <!-- Active Indicator -->
          <span *ngIf="selectedLevel2Item === level2Item"
                class="active-indicator
                       animate-pulse"></span>
          <!-- Badge -->
          <span *ngIf="level2Item.badge"
                class="absolute top-0 right-0 w-5 h-5 rounded-full
                       flex items-center justify-center text-xs font-bold
                       bg-red-500 text-white
                       transform translate-x-1 -translate-y-1
                       z-20">{{ level2Item.badge }}</span>
          <!-- Tooltip -->
          <span class="module-tooltip
                       animate-fade-in
                       [animation-delay:100ms]">{{ translateLabel(level2Item.label, selectedNavigationItem ? selectedNavigationItem.id : undefined, 2) }}</span>
        </button>
      </ng-container>

      <!-- Level 1 Items (Home, ESS, Admin) - Show when no Level 1 is selected or no Level 2 items -->
      <ng-container *ngIf="!selectedNavigationItem || level2Items.length === 0">
        <button *ngFor="let navItem of navigationItems; let i = index"
                (click)="selectNavigationItem(navItem.id)"
                [class.active]="selectedNavigationItem && selectedNavigationItem.id === navItem.id"
                [attr.aria-label]="translateLabel(navItem.label, navItem.id, 1)"
                [attr.aria-current]="selectedNavigationItem && selectedNavigationItem.id === navItem.id ? 'true' : 'false'"
                [attr.title]="translateLabel(navItem.label, navItem.id, 1)"
                [style.animation-delay.ms]="i * 50"
                class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                       transition-all duration-300 ease-out
                       hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                       active:scale-95
                       relative group
                       animate-fade-in
                       cursor-pointer
                       border-0 bg-transparent">
          <!-- Hover Background -->
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <!-- Icon -->
          <span class="material-icons text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90">
            {{ navItem.icon }}
          </span>
          <!-- Active Indicator -->
          <span *ngIf="selectedNavigationItem && selectedNavigationItem.id === navItem.id"
                class="active-indicator
                       animate-pulse"></span>
          <!-- Badge -->
          <span *ngIf="navItem.badge"
                class="absolute top-0 right-0 w-5 h-5 rounded-full
                       flex items-center justify-center text-xs font-bold
                       bg-red-500 text-white
                       transform translate-x-1 -translate-y-1
                       z-20">{{ navItem.badge }}</span>
          <!-- Tooltip -->
          <span class="module-tooltip
                       animate-fade-in
                       [animation-delay:100ms]">{{ translateLabel(navItem.label, navItem.id, 1) }}</span>
        </button>
      </ng-container>

      <!-- Fallback to legacy modules if navigationItems is empty -->
      <ng-container *ngIf="navigationItems.length === 0">
        <a *ngFor="let module of mainModules; let i = index"
           [routerLink]="getModuleHomeRoute(module.id)"
           routerLinkActive="active"
           [routerLinkActiveOptions]="{exact: false}"
           [class.active]="selectedModule === module.id"
           [attr.aria-label]="module.name"
           [attr.aria-current]="selectedModule === module.id ? 'true' : 'false'"
           [attr.title]="module.name"
           [style.animation-delay.ms]="i * 50"
           class="module-icon-btn w-full h-12 flex items-center justify-center rounded-xl
                  transition-all duration-300 ease-out
                  hover:scale-110 hover:shadow-lg hover:-translate-y-0.5
                  active:scale-95
                  relative group
                  animate-fade-in">
          <!-- Hover Background -->
          <div class="absolute inset-0 rounded-xl
                      bg-gradient-to-br from-blue-500/0 to-indigo-500/0
                      group-hover:from-blue-500/10 group-hover:to-indigo-500/10
                      transition-all duration-300"></div>
          <span *ngIf="module.iconCss"
                [class]="module.iconCss"
                class="text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90"></span>
          <span *ngIf="!module.iconCss"
                class="text-xl transition-all duration-300 relative z-10
                       group-hover:scale-110 group-hover:rotate-6
                       text-gray-700 dark:text-gray-300 theme-gemini:text-white/90
                       e-icons e-folder"></span>
          <!-- Active Indicator -->
          <span *ngIf="selectedModule === module.id"
                class="active-indicator
                       animate-pulse"></span>
          <!-- Tooltip -->
          <span class="module-tooltip
                       animate-fade-in
                       [animation-delay:100ms]">{{ module.name }}</span>
        </a>
      </ng-container>
    </div>
  </div>

  <!-- Right Menu Panel - Module Menu -->
  <div class="menu-panel flex-1 flex flex-col overflow-hidden
              transition-all duration-300 ease-in-out
              bg-gradient-to-br from-white/5 via-white/10 to-white/5
              dark:from-gray-900/20 dark:via-gray-900/30 dark:to-gray-900/20
              theme-gemini:from-gray-900/30 theme-gemini:via-gray-900/40 theme-gemini:to-gray-900/30
              backdrop-blur-md border-l border-white/10 dark:border-gray-800/30 theme-gemini:border-white/20">
    <div class="p-6 flex-1 overflow-y-auto">
      <!-- Header Section -->
      <div class="mb-6">
        <!-- Module Title -->
        <div class="mb-4" *ngIf="selectedLevel2Item || selectedNavigationItem">
          <h2 class="module-title text-xl font-bold thai-text
                     text-gray-800 dark:text-gray-100 theme-gemini:text-white
                     mb-1 transition-colors duration-300">
            {{ translateLabel((selectedLevel2Item ? selectedLevel2Item.label : (selectedNavigationItem ? selectedNavigationItem.label : '')) || '', selectedNavigationItem ? selectedNavigationItem.id : undefined, selectedLevel2Item ? 2 : 1) || ('layout.sidebar.menu' | translate) }}
          </h2>
          <p class="text-xs text-gray-500 dark:text-gray-400 theme-gemini:text-white/70" *ngIf="selectedNavigationItem">
            {{ translateLabel(selectedNavigationItem.label, selectedNavigationItem.id, 1) }}
          </p>
        </div>

        <!-- Back Button (when in Level 3+) -->
        <div class="mb-4" *ngIf="(selectedNavigationItem && selectedNavigationItem.id === 'admin' && selectedLevel3Item) ||
                                 (selectedNavigationItem && selectedNavigationItem.id === 'ess' && (selectedLevel3Item || selectedLevel4Item))">
          <button (click)="goBackToLevel2()"
                  class="back-button flex items-center gap-2 px-4 py-2 rounded-lg
                         transition-all duration-200 ease-out
                         bg-white/20 dark:bg-gray-800/30 theme-gemini:bg-white/10
                         hover:bg-white/30 dark:hover:bg-gray-700/40 theme-gemini:hover:bg-white/20
                         hover:scale-[1.02] active:scale-[0.98]
                         text-sm font-medium
                         text-gray-700 dark:text-gray-300 theme-gemini:text-white/90
                         cursor-pointer border-0
                         backdrop-blur-sm
                         border border-white/30 dark:border-gray-700/30 theme-gemini:border-white/20">
            <span class="material-icons text-base">arrow_back</span>
            <span class="thai-text">{{ 'layout.sidebar.back' | translate }}</span>
          </button>
        </div>

        <!-- Search Box -->
        <div class="search-container mb-4 relative animate-fade-in" *ngIf="navigationChildren.length > 3 || filteredMenuItems.length > 3">
          <app-glass-input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            [placeholder]="'layout.sidebar.searchMenuPlaceholder' | translate"
            [ariaLabel]="'layout.sidebar.searchMenu' | translate"
            customClass="w-full pr-11">
            <ng-container *ngIf="searchQuery">
              <button
                (click)="clearSearch()"
                class="absolute right-2 top-1/2 -translate-y-1/2
                       w-8 h-8 flex items-center justify-center rounded-lg
                       hover:bg-gray-200/50 dark:hover:bg-gray-700/50 theme-gemini:hover:bg-white/20
                       hover:scale-110 active:scale-95
                       transition-all duration-200 ease-out"
                [attr.aria-label]="'layout.sidebar.clearSearch' | translate"
                type="button">
                <app-icon name="close" size="sm"
                          color="text-gray-500 dark:text-gray-400 theme-gemini:text-white/70
                                 hover:text-red-500 dark:hover:text-red-400
                                 transition-colors duration-200"></app-icon>
              </button>
            </ng-container>
          </app-glass-input>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="space-y-3">
        <app-skeleton-loader
          [type]="'list'"
          [rows]="5">
        </app-skeleton-loader>
      </div>

      <!-- Module Menu Items - Using Nested Accordion -->
      <!-- Show Level 3 items when Level 2 is selected (Level 4 as children) -->
      <ng-container *ngIf="!isLoading && navigationChildren.length > 0">
        <div class="nested-menu-container
                    bg-white/20 dark:bg-gray-800/20 theme-gemini:bg-white/5
                    backdrop-blur-sm rounded-xl
                    border border-white/20 dark:border-gray-700/20 theme-gemini:border-white/10">
          <app-nested-menu-accordion
            [items]="navigationChildren"
            [activeRoute]="activeRoute"
            [level]="3"
            [expandedItems]="expandedLevel3Items"
            [navId]="selectedNavigationItem ? selectedNavigationItem.id : undefined"
            (itemClick)="onAccordionItemClick($event)"
            (toggleExpand)="onAccordionToggleExpand($event)">
          </app-nested-menu-accordion>
        </div>
      </ng-container>

      <!-- Fallback to Legacy ListView (if no navigation children) -->
      <ejs-listview
        *ngIf="!isLoading && navigationChildren.length === 0 && filteredMenuItems && filteredMenuItems.length > 0"
        #listview
        [dataSource]="filteredMenuItems"
        [fields]="listViewFields"
        [showIcon]="true"
        [showCheckBox]="false"
        (select)="onMenuItemSelect($event)"
        class="syncfusion-module-menu">
      </ejs-listview>

      <!-- Search No Results -->
      <app-empty-state
        *ngIf="!isLoading && searchQuery && navigationChildren.length === 0 && filteredMenuItems.length === 0"
        [icon]="'search_off'"
        [title]="'layout.sidebar.noSearchResults' | translate"
        [description]="'layout.sidebar.tryDifferentSearch' | translate">
        <app-glass-button
          variant="secondary"
          size="sm"
          [ariaLabel]="'layout.sidebar.clearSearch' | translate"
          (clicked)="clearSearch()">
          {{ 'layout.sidebar.clearSearch' | translate }}
        </app-glass-button>
      </app-empty-state>

      <!-- Empty State - No Menu Items -->
      <app-empty-state
        *ngIf="!isLoading && !searchQuery && navigationChildren.length === 0 && displayMenuItems.length === 0"
        [icon]="'folder_open'"
        [title]="'layout.sidebar.noMenuInMode' | translate">
      </app-empty-state>
    </div>

    <!-- User Avatar Section - Bottom of Menu Panel -->
    <div class="user-avatar-section border-t transition-colors duration-300" *ngIf="currentUser" #userMenuContainer>
      <div class="p-4">
        <div class="user-info-container flex items-center gap-3 cursor-pointer group
                     transition-all duration-300 ease-out
                     hover:scale-[1.02] hover:bg-white/5 dark:hover:bg-gray-800/20 theme-gemini:hover:bg-white/10
                     rounded-lg p-2 -mx-2"
             (click)="toggleUserMenu()"
             (keydown.enter)="toggleUserMenu()"
             (keydown.space)="toggleUserMenu(); $event.preventDefault()"
             [attr.aria-label]="'layout.sidebar.userMenu' | translate"
             [attr.aria-expanded]="showUserMenu"
             role="button"
             tabindex="0">
          <!-- Avatar -->
          <div class="group-hover:scale-110 group-hover:shadow-xl group-hover:ring-2 group-hover:ring-blue-500/50
                      transition-all duration-300 ease-out">
            <app-avatar
              [src]="getAvatarUrl() || ''"
              [name]="getUserDisplayName()"
              size="md"
              [status]="'online'">
            </app-avatar>
          </div>

          <!-- User Info -->
          <div class="user-info flex-1 min-w-0">
            <div class="user-name text-sm font-semibold thai-text transition-colors duration-300 truncate">
              {{ getUserDisplayName() }}
            </div>
            <div class="user-role text-xs transition-colors duration-300 truncate" *ngIf="getUserRole()">
              {{ getUserRole() }}
            </div>
          </div>

          <!-- Dropdown Icon -->
          <div class="dropdown-icon transition-transform duration-300 ease-out
                       group-hover:scale-110"
               [class.rotated]="showUserMenu">
            <span class="e-icons e-chevron-down
                         group-hover:text-blue-500 dark:group-hover:text-blue-400
                         transition-colors duration-300"></span>
          </div>
        </div>

        <!-- User Menu Dropdown -->
        <div class="user-menu-dropdown
                     animate-fade-in
                     [animation-duration:200ms]"
             *ngIf="showUserMenu"
             @slideDown>
          <div class="user-menu-items">
            <a routerLink="/portal/self-service/profile"
               class="user-menu-item
                      transition-all duration-200 ease-out
                      hover:translate-x-1 hover:scale-[1.02]
                      active:scale-[0.98]"
               (click)="showUserMenu = false"
               [attr.aria-label]="'layout.sidebar.profile' | translate">
              <app-icon name="person" size="sm"
                        color="text-gray-600 dark:text-gray-400 theme-gemini:text-white/70
                               group-hover:text-blue-500 dark:group-hover:text-blue-400
                               transition-colors duration-200"
                        class="group-hover:scale-110 transition-transform duration-200"></app-icon>
              <span class="thai-text">{{ 'layout.sidebar.profile' | translate }}</span>
            </a>
            <a routerLink="/portal/admin/settings"
               class="user-menu-item
                      transition-all duration-200 ease-out
                      hover:translate-x-1 hover:scale-[1.02]
                      active:scale-[0.98]"
               (click)="showUserMenu = false"
               [attr.aria-label]="'layout.sidebar.settings' | translate">
              <app-icon name="settings" size="sm"
                        color="text-gray-600 dark:text-gray-400 theme-gemini:text-white/70
                               group-hover:text-blue-500 dark:group-hover:text-blue-400
                               transition-colors duration-200"
                        class="group-hover:scale-110 transition-transform duration-200"></app-icon>
              <span class="thai-text">{{ 'layout.sidebar.settings' | translate }}</span>
            </a>
            <!-- Admin Menu Option (only show if user has admin role) -->
            <button *ngIf="hasAdminRole()"
                    class="user-menu-item
                           transition-all duration-200 ease-out
                           hover:translate-x-1 hover:scale-[1.02]
                           active:scale-[0.98]"
                    (click)="switchToAdmin(); showUserMenu = false"
                    [attr.aria-label]="'layout.sidebar.admin' | translate"
                    type="button">
              <app-icon name="shield-check" size="sm"
                        color="text-gray-600 dark:text-gray-400 theme-gemini:text-white/70
                               group-hover:text-blue-500 dark:group-hover:text-blue-400
                               transition-colors duration-200"
                        class="group-hover:scale-110 transition-transform duration-200"></app-icon>
              <span class="thai-text">{{ 'layout.sidebar.admin' | translate }}</span>
            </button>
            <div class="user-menu-divider"></div>
            <button
              class="user-menu-item text-red-500 dark:text-red-400
                     transition-all duration-200 ease-out
                     hover:translate-x-1 hover:scale-[1.02] hover:bg-red-50 dark:hover:bg-red-900/20
                     active:scale-[0.98]"
              (click)="logout()"
              [attr.aria-label]="'layout.sidebar.logout' | translate"
              type="button">
              <app-icon name="logout" size="sm"
                        color="text-red-500 dark:text-red-400
                               group-hover:scale-110 transition-transform duration-200"></app-icon>
              <span class="thai-text">{{ 'layout.sidebar.logout' | translate }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
