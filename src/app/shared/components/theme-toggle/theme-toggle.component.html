<div class="relative theme-toggle-container">
  <!-- Combined Theme Toggle Button -->
  <button
    #themeButton
    (click)="toggleThemeMenu()"
    [attr.aria-label]="'เปลี่ยนธีมและสี'"
    [attr.aria-expanded]="showThemeMenu || showColorPicker"
    [attr.aria-haspopup]="true"
    role="button"
    tabindex="0"
    class="p-2 text-slate-700 dark:text-slate-200 hover:bg-white/30 dark:hover:bg-slate-700/30 rounded-lg transition-all duration-200 flex items-center gap-2 theme-myhr:glass-myhr-weak theme-myhr:hover:drop-shadow-[0_0_4px_rgba(var(--primary-rgb),0.4)]"
  >
    <app-icon
      name="palette"
      size="md"
      color="text-slate-700 dark:text-slate-200"
      [ariaLabel]="'สีธีมปัจจุบัน: ' + currentColor"
    ></app-icon>
  </button>

  <!-- Combined Theme Menu -->
  <div
    *ngIf="showThemeMenu && !showColorPicker"
    role="menu"
    [attr.aria-label]="'เมนูเลือกธีมและสี'"
    class="theme-menu absolute right-0 mt-2 w-72 bg-white/90 dark:bg-slate-900/90 backdrop-blur-lg rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 max-h-[85vh] overflow-y-auto animate-fade-in theme-myhr:glass-myhr theme-myhr:shadow-myhr theme-myhr:border-primary/30"
  >
    <!-- Theme Mode Section -->
    <div class="p-3 border-b border-gray-200 dark:border-gray-700">
      <h3
        class="text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2 uppercase tracking-wide"
      >
        โหมดธีม
      </h3>
      <div class="grid grid-cols-3 gap-2">
        <button
          role="menuitemradio"
          [attr.aria-checked]="currentMode === 'light'"
          (click)="setMode('light')"
          [class.active]="currentMode === 'light'"
          class="theme-mode-btn relative px-3 py-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col items-center gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary theme-myhr:[&.active]:glass-myhr theme-myhr:[&.active]:bg-gradient-to-br theme-myhr:[&.active]:from-primary/20 theme-myhr:[&.active]:to-primary/20 theme-myhr:[&.active]:text-primary"
          [attr.aria-label]="'โหมดสว่าง'"
        >
          <!-- Preview thumbnail -->
          <div
            class="preview-thumbnail w-full h-12 rounded-md mb-1 border border-slate-200 dark:border-slate-700"
            [style.background]="getModePreview('light')">
          </div>
          <app-icon
            name="light_mode"
            size="sm"
            color="text-slate-600 dark:text-slate-400"
            aria-hidden="true"
          ></app-icon>
          <span class="text-[10px] font-medium">สว่าง</span>
        </button>
        <button
          role="menuitemradio"
          [attr.aria-checked]="currentMode === 'dark'"
          (click)="setMode('dark')"
          [class.active]="currentMode === 'dark'"
          class="theme-mode-btn relative px-3 py-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col items-center gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary theme-myhr:[&.active]:glass-myhr theme-myhr:[&.active]:bg-gradient-to-br theme-myhr:[&.active]:from-primary/20 theme-myhr:[&.active]:to-primary/20 theme-myhr:[&.active]:text-primary"
          [attr.aria-label]="'โหมดมืด'"
        >
          <!-- Preview thumbnail -->
          <div
            class="preview-thumbnail w-full h-12 rounded-md mb-1 border border-slate-200 dark:border-slate-700"
            [style.background]="getModePreview('dark')">
          </div>
          <app-icon
            name="dark_mode"
            size="sm"
            color="text-slate-600 dark:text-slate-400"
            aria-hidden="true"
          ></app-icon>
          <span class="text-[10px] font-medium">มืด</span>
        </button>
        <button
          role="menuitemradio"
          [attr.aria-checked]="currentMode === 'auto'"
          (click)="setMode('auto')"
          [class.active]="currentMode === 'auto'"
          class="theme-mode-btn relative px-3 py-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col items-center gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary theme-myhr:[&.active]:glass-myhr theme-myhr:[&.active]:bg-gradient-to-br theme-myhr:[&.active]:from-primary/20 theme-myhr:[&.active]:to-primary/20 theme-myhr:[&.active]:text-primary"
          [attr.aria-label]="'อัตโนมัติ'"
        >
          <!-- Preview thumbnail -->
          <div
            class="preview-thumbnail w-full h-12 rounded-md mb-1 border border-slate-200 dark:border-slate-700"
            [style.background]="getModePreview('auto')">
          </div>
          <app-icon
            name="brightness_auto"
            size="sm"
            color="text-slate-600 dark:text-slate-400"
            aria-hidden="true"
          ></app-icon>
          <span class="text-[10px] font-medium">อัตโนมัติ</span>
        </button>
      </div>
    </div>

    <!-- Background Styles Accordion Section -->
    <div class="border-b border-gray-200 dark:border-gray-700">
      <!-- Sidebar Style Accordion -->
      <div class="border-b border-gray-200/50 dark:border-gray-700/50 last:border-b-0">
        <button
          (click)="showSidebarAccordion = !showSidebarAccordion"
          class="w-full px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 hover:bg-white/20 dark:hover:bg-slate-700/20 flex items-center justify-between transition-all duration-200"
          [attr.aria-expanded]="showSidebarAccordion"
        >
          <span class="flex items-center gap-2">
            <app-icon name="view_sidebar" size="xs" aria-hidden="true"></app-icon>
            <span>Sidebar</span>
          </span>
          <app-icon
            [name]="showSidebarAccordion ? 'expand_less' : 'expand_more'"
            size="xs"
            aria-hidden="true"
          ></app-icon>
        </button>
        <div
          *ngIf="showSidebarAccordion"
          class="px-3 pb-2 grid grid-cols-2 gap-2"
        >
          <button
            *ngFor="let style of sidebarStyles"
            role="menuitemradio"
            [attr.aria-checked]="currentSidebarStyle === style.value"
            (click)="setSidebarStyle(style.value)"
            [class.active]="currentSidebarStyle === style.value"
            class="style-option-btn relative p-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary"
            [attr.aria-label]="style.name"
          >
            <!-- Preview thumbnail -->
            <div
              class="preview-thumbnail w-full h-10 rounded border border-slate-200 dark:border-slate-700"
              [style.background]="getStylePreview(style.value, 'sidebar')">
            </div>
            <div class="flex items-center gap-1.5">
              <app-icon
                [name]="style.icon"
                size="xs"
                color="text-slate-600 dark:text-slate-400"
                aria-hidden="true"
              ></app-icon>
              <span class="truncate text-[10px] font-medium">{{ style.name }}</span>
              <span *ngIf="currentSidebarStyle === style.value" class="ml-auto">
                <app-icon name="check" size="xs" color="text-primary" aria-hidden="true"></app-icon>
              </span>
            </div>
          </button>
        </div>
      </div>

      <!-- Header Style Accordion -->
      <div class="border-b border-gray-200/50 dark:border-gray-700/50 last:border-b-0">
        <button
          (click)="showHeaderAccordion = !showHeaderAccordion"
          class="w-full px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 hover:bg-white/20 dark:hover:bg-slate-700/20 flex items-center justify-between transition-all duration-200"
          [attr.aria-expanded]="showHeaderAccordion"
        >
          <span class="flex items-center gap-2">
            <app-icon name="horizontal_rule" size="xs" aria-hidden="true"></app-icon>
            <span>Header</span>
          </span>
          <app-icon
            [name]="showHeaderAccordion ? 'expand_less' : 'expand_more'"
            size="xs"
            aria-hidden="true"
          ></app-icon>
        </button>
        <div
          *ngIf="showHeaderAccordion"
          class="px-3 pb-2 grid grid-cols-2 gap-2"
        >
          <button
            *ngFor="let style of headerStyles"
            role="menuitemradio"
            [attr.aria-checked]="currentHeaderStyle === style.value"
            (click)="setHeaderStyle(style.value)"
            [class.active]="currentHeaderStyle === style.value"
            class="style-option-btn relative p-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary"
            [attr.aria-label]="style.name"
          >
            <!-- Preview thumbnail -->
            <div
              class="preview-thumbnail w-full h-10 rounded border border-slate-200 dark:border-slate-700"
              [style.background]="getStylePreview(style.value, 'header')">
            </div>
            <div class="flex items-center gap-1.5">
              <app-icon
                [name]="style.icon"
                size="xs"
                color="text-slate-600 dark:text-slate-400"
                aria-hidden="true"
              ></app-icon>
              <span class="truncate text-[10px] font-medium">{{ style.name }}</span>
              <span *ngIf="currentHeaderStyle === style.value" class="ml-auto">
                <app-icon name="check" size="xs" color="text-primary" aria-hidden="true"></app-icon>
              </span>
            </div>
          </button>
        </div>
      </div>

      <!-- Main Layout Style Accordion -->
      <div class="border-b border-gray-200/50 dark:border-gray-700/50 last:border-b-0">
        <button
          (click)="showMainLayoutAccordion = !showMainLayoutAccordion"
          class="w-full px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 hover:bg-white/20 dark:hover:bg-slate-700/20 flex items-center justify-between transition-all duration-200"
          [attr.aria-expanded]="showMainLayoutAccordion"
        >
          <span class="flex items-center gap-2">
            <app-icon name="dashboard" size="xs" aria-hidden="true"></app-icon>
            <span>Main Layout</span>
          </span>
          <app-icon
            [name]="showMainLayoutAccordion ? 'expand_less' : 'expand_more'"
            size="xs"
            aria-hidden="true"
          ></app-icon>
        </button>
        <div
          *ngIf="showMainLayoutAccordion"
          class="px-3 pb-2 grid grid-cols-2 gap-2"
        >
          <button
            *ngFor="let style of mainLayoutStyles"
            role="menuitemradio"
            [attr.aria-checked]="currentMainLayoutStyle === style.value"
            (click)="setMainLayoutStyle(style.value)"
            [class.active]="currentMainLayoutStyle === style.value"
            class="style-option-btn relative p-2 text-xs text-slate-700 dark:text-slate-200 rounded-lg flex flex-col gap-1.5 transition-all duration-300 hover:scale-105 hover:shadow-md active:scale-95 border-2 border-transparent [&.active]:border-primary [&.active]:ring-2 [&.active]:ring-primary/50 [&.active]:bg-primary/10 [&.active]:shadow-primary"
            [attr.aria-label]="style.name"
          >
            <!-- Preview thumbnail -->
            <div
              class="preview-thumbnail w-full h-10 rounded border border-slate-200 dark:border-slate-700"
              [style.background]="getStylePreview(style.value, 'main-layout')">
            </div>
            <div class="flex items-center gap-1.5">
              <app-icon
                [name]="style.icon"
                size="xs"
                color="text-slate-600 dark:text-slate-400"
                aria-hidden="true"
              ></app-icon>
              <span class="truncate text-[10px] font-medium">{{ style.name }}</span>
              <span *ngIf="currentMainLayoutStyle === style.value" class="ml-auto">
                <app-icon name="check" size="xs" color="text-primary" aria-hidden="true"></app-icon>
              </span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Theme Color Section -->
    <div class="p-3 border-b border-gray-200 dark:border-gray-700">
      <h3
        class="text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2 uppercase tracking-wide"
      >
        สีธีม
      </h3>
      <div class="grid grid-cols-3 gap-2 mb-2" role="group">
        <button
          *ngFor="let color of themeColors"
          role="menuitemradio"
          [attr.aria-checked]="currentColor === color.value"
          (click)="setColor(color.value)"
          [ngClass]="{
            'active': currentColor === color.value,
            'border-primary': currentColor === color.value,
            'border-slate-300': currentColor !== color.value,
            'ring-2': currentColor === color.value,
            'shadow-primary-lg': currentColor === color.value
          }"
          class="theme-color-btn relative w-full aspect-square rounded-lg border-2 transition-all duration-300 hover:scale-110 hover:shadow-lg active:scale-95 focus:outline-none focus:ring-2 dark:border-slate-600"
          [class.border-slate-300]="currentColor !== color.value"
          [style.background]="color.gradient"
          [attr.data-gradient]="color.gradient"
          [attr.aria-label]="color.name"
          [attr.title]="color.name"
        >
          <!-- Glow effect for active state -->
          <span
            *ngIf="currentColor === color.value"
            class="absolute inset-0 rounded-lg bg-gradient-to-br from-primary/20 to-primary/10 animate-pulse pointer-events-none"
          ></span>
          <!-- Tooltip -->
          <span
            class="theme-color-tooltip absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 text-[10px] font-medium text-white bg-slate-900 dark:bg-slate-800 rounded opacity-0 pointer-events-none transition-opacity duration-200 whitespace-nowrap z-10"
          >
            {{ color.name }}
          </span>
        </button>
      </div>
      <button
        (click)="toggleColorPicker($event)"
        class="w-full px-2 py-1.5 text-xs text-slate-700 dark:text-slate-200 hover:bg-white/40 dark:hover:bg-slate-700/40 rounded-lg flex items-center justify-between transition-all duration-200"
      >
        <span class="flex items-center gap-1.5">
          <app-icon
            name="colorize"
            size="xs"
            color="text-slate-600 dark:text-slate-400"
            aria-hidden="true"
          ></app-icon>
          <span>เลือกสีเอง</span>
        </span>
        <span
          class="w-4 h-4 rounded border border-slate-300 dark:border-slate-600"
          [style.background-color]="customPrimaryColor"
          [attr.data-color]="customPrimaryColor"
        >
        </span>
      </button>
    </div>

    <!-- Reset Button -->
    <div class="p-3">
      <button
        (click)="resetTheme()"
        class="w-full px-3 py-2 text-xs text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-all duration-200 flex items-center justify-center gap-2"
      >
        <app-icon
          name="refresh"
          size="xs"
          color="text-slate-600 dark:text-slate-400"
          aria-hidden="true"
        ></app-icon>
        <span>รีเซ็ต</span>
      </button>
    </div>
  </div>

  <!-- Custom Color Picker -->
  <div
    *ngIf="showColorPicker"
    (click)="$event.stopPropagation()"
    role="dialog"
    [attr.aria-label]="'เลือกสีเอง'"
    class="color-picker-popup absolute right-0 mt-2 w-80 bg-white/90 dark:bg-slate-900/90 backdrop-blur-lg rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 z-[100] animate-fade-in"
  >
    <div class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200">เลือกสีเอง</h3>
        <button
          (click)="showColorPicker = false; showThemeMenu = true; $event.stopPropagation()"
          class="p-1 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 rounded transition-colors"
          [attr.aria-label]="'กลับ'"
        >
          <app-icon name="arrow_back" size="sm" aria-hidden="true"></app-icon>
        </button>
      </div>
      <div class="flex items-center gap-3">
        <input
          type="color"
          [value]="customPrimaryColor"
          (input)="onColorPickerChange($event)"
          class="w-16 h-16 rounded-lg border-2 border-slate-300 dark:border-slate-600 cursor-pointer hover:scale-105 transition-transform duration-200"
          [attr.aria-label]="'เลือกสี'"
        />
        <div class="flex-1">
          <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">Hex Color</label>
          <input
            type="text"
            [(ngModel)]="hexColorInput"
            (input)="onHexInputChange($event)"
            [placeholder]="customPrimaryColor"
            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 dark:border-slate-600 bg-white/50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200"
            [attr.aria-label]="'ใส่ hex color code'"
          />
        </div>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <span class="text-xs text-slate-600 dark:text-slate-400">สีปัจจุบัน:</span>
        <span
          class="w-8 h-8 rounded border-2 border-slate-300 dark:border-slate-600"
          [style.background-color]="customPrimaryColor"
          [attr.aria-label]="'สีที่เลือก: ' + customPrimaryColor"
        >
        </span>
        <span class="text-xs font-mono text-slate-700 dark:text-slate-200">{{
          customPrimaryColor
        }}</span>
      </div>
    </div>
    <div class="flex gap-2">
      <button
        (click)="showColorPicker = false; showThemeMenu = false; $event.stopPropagation()"
        class="flex-1 px-4 py-2 text-sm text-white bg-primary hover:bg-primary/90 rounded-lg transition-all duration-200"
      >
        <span>ปิด</span>
      </button>
    </div>
  </div>
</div>
