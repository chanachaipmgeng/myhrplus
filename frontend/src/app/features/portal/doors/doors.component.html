<app-page-layout
  title="Door Management"
  description="Manage doors and assign employee access permissions. Configure door devices and monitor entry logs."
  icon="üö™"
  [actions]="pageActions()">
  
  <!-- Doors Table -->
  <app-data-table
    [columns]="columns"
    [data]="doors()"
    [actions]="actions"
    [searchable]="true"
  >
    <div actions>
      <app-glass-button (clicked)="loadDoors()">
        üîÑ {{ 'common.refresh' | translate }}
      </app-glass-button>
    </div>
  </app-data-table>

  <!-- Add/Edit Modal Form -->
  <app-modal-form
    [isOpen]="showModal()"
    [title]="(editingDoor() ? 'Edit Door' : 'Add Door') | translate"
    [fields]="doorFormFields()"
    [loading]="saving()"
    [submitLabel]="'common.save' | translate"
    [cancelLabel]="'common.cancel' | translate"
    (closed)="closeModal()"
    (submitted)="onFormSubmitted($event)"
  />

  <!-- Empty State for Doors -->
  @if (doors().length === 0 && !getLoading()()) {
    <app-empty-state
      icon="üö™"
      [title]="'common.emptyState.title' | translate"
      [description]="'No doors found. Add your first door to get started.'"
      [action]="{
        label: 'Add Door',
        icon: '‚ûï',
        variant: 'primary',
        onClick: openAddModal.bind(this)
      }"
    />
  }

  <!-- Permission Management Modal -->
  <app-modal
    [isOpen]="showPermissionModal()"
    [title]="'Manage Permissions - ' + (selectedDoorForPermission()?.doorName || '')"
    [loading]="saving()"
    (closed)="closePermissionModal()"
  >
    <div class="space-y-6">
      @if (loadingPermissions()) {
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto"></div>
          <p class="mt-2 text-gray-600 dark:text-gray-400">Loading permissions...</p>
        </div>
      } @else {
        <!-- Door Info -->
        <div class="bg-sky-50 dark:bg-sky-900/20 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900 dark:text-gray-100">
                {{ selectedDoorForPermission()?.doorName }}
              </p>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                üìç {{ selectedDoorForPermission()?.location }}
              </p>
            </div>
            <div class="text-right">
              <p class="text-2xl font-bold text-sky-600 dark:text-sky-400">
                {{ doorPermissions().length }}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">Permissions</p>
            </div>
          </div>
        </div>

        <!-- Current Permissions -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">
            üîë Current Permissions ({{ doorPermissions().length }})
          </h3>
          @if (doorPermissions().length === 0) {
            <div class="text-center py-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <p class="text-gray-500 dark:text-gray-400">No permissions granted yet</p>
            </div>
          } @else {
            <div class="space-y-2 max-h-60 overflow-y-auto">
              @for (permission of doorPermissions(); track permission.id) {
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                  <div class="flex items-center space-x-3">
                    <span class="text-2xl">üë§</span>
                    <div>
                      <p class="font-medium text-gray-900 dark:text-gray-100">
                        {{ getEmployeeName(permission.companyEmployeeId || permission.employeeId) }}
                      </p>
                      <p class="text-sm text-gray-500 dark:text-gray-400">
                        Access Type: {{ permission.accessType || 'Full' }}
                      </p>
                    </div>
                  </div>
                  <button
                    (click)="revokePermission(permission)"
                    class="px-3 py-1 text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium transition-colors"
                  >
                    üóëÔ∏è Revoke
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Grant New Permissions -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">
            ‚ûï Grant Permissions
          </h3>
          @if (availableEmployees().length === 0) {
            <div class="text-center py-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <p class="text-gray-500 dark:text-gray-400">All employees already have permissions</p>
            </div>
          } @else {
            <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
              @for (employee of availableEmployees(); track employee.id) {
                <label class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-sky-50 dark:hover:bg-sky-900/20 cursor-pointer transition-colors">
                  <input
                    type="checkbox"
                    [checked]="selectedEmployees().includes(employee.id)"
                    (change)="toggleEmployeeSelection(employee.id)"
                    class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded focus:ring-sky-500 dark:focus:ring-sky-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                  />
                  <div class="ml-3">
                    <p class="font-medium text-gray-900 dark:text-gray-100">
                      {{ employee.first_name }} {{ employee.last_name }}
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                      {{ employee.department }} - {{ employee.position }}
                    </p>
                  </div>
                </label>
              }
            </div>

            <div class="flex items-center justify-between pt-2">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                {{ selectedEmployees().length }} employee(s) selected
              </p>
              <app-glass-button
                variant="primary"
                [disabled]="selectedEmployees().length === 0 || saving()"
                (clicked)="grantPermissions()"
              >
                {{ saving() ? '‚è≥ Granting...' : '‚úÖ Grant Permissions' }}
              </app-glass-button>
            </div>
          }
        </div>
      }
    </div>
  </app-modal>
</app-page-layout>
