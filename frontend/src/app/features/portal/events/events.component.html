<app-page-layout
  title="Event Management"
  description="Create events, share public registration links, and manage attendees with face recognition check-in."
  icon="üéâ"
  [actions]="pageActions()">
  
  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-800 text-sm">{{ errorMessage() }}</p>
    </div>
  }

  <!-- Filters -->
  <app-filter-section
    [fields]="filterFields()"
    [columns]="4"
    (filterChange)="onFilterChange($event)"
  />

  <!-- Events Table -->
  <app-data-table
    [columns]="columns"
    [data]="events()"
    [actions]="actions"
    [searchable]="false"
  />

  <!-- Pagination -->
  <div class="flex items-center justify-between mt-4 text-gray-600 dark:text-gray-400">
    <div class="text-sm">
      Showing {{ (currentPage() - 1) * pageSizeEvents() + 1 }} - {{ currentPage() * pageSizeEvents() > totalEvents() ? totalEvents() : currentPage() * pageSizeEvents() }} of {{ totalEvents() }} events
    </div>
    <div class="flex items-center gap-2">
      <app-glass-button [disabled]="currentPage() === 1" (clicked)="onPageChange(currentPage() - 1)">
        &laquo; {{ 'common.previous' | translate }}
      </app-glass-button>
      <span class="font-semibold">{{ 'common.page' | translate }} {{ currentPage() }} {{ 'common.of' | translate }} {{ totalPages() }}</span>
      <app-glass-button [disabled]="currentPage() === totalPages()" (clicked)="onPageChange(currentPage() + 1)">
        {{ 'common.next' | translate }} &raquo;
      </app-glass-button>
    </div>
  </div>

  <!-- Add/Edit Event Modal -->
  <app-modal
    [isOpen]="showModal()"
    [title]="(editingEvent() ? 'Edit Event' : 'Create Event') | translate"
    [loading]="saving()"
    (closed)="closeModal()"
    (confirmed)="saveEvent()"
  >
    <form [formGroup]="eventForm" class="space-y-4">
      <!-- Event Name -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Event Name <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="eventName"
          type="text"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          placeholder="Enter event name"
        />
        <p *ngIf="eventForm.get('eventName')?.invalid && eventForm.get('eventName')?.touched" class="text-red-500 text-sm mt-1">
          Event name is required
        </p>
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Description
        </label>
        <textarea
          formControlName="description"
          rows="4"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          placeholder="Enter event description"
        ></textarea>
      </div>

      <!-- Start Date -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Start Date <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="startDate"
          type="datetime-local"
          [min]="!editingEvent() ? getCurrentDateTimeLocal() : ''"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
        <p *ngIf="eventForm.get('startDate')?.invalid && eventForm.get('startDate')?.touched" class="text-red-500 text-sm mt-1">
          Start date is required
        </p>
      </div>

      <!-- End Date -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          End Date <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="endDate"
          type="datetime-local"
          [min]="eventForm.get('startDate')?.value || (!editingEvent() ? getCurrentDateTimeLocal() : '')"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
        <p *ngIf="eventForm.get('endDate')?.invalid && eventForm.get('endDate')?.touched" class="text-red-500 text-sm mt-1">
          End date is required
        </p>
      </div>

      <!-- Date Error -->
      @if (dateError()) {
        <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-red-800 dark:text-red-200 text-sm">{{ dateError() }}</p>
        </div>
      }

      <!-- Location -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Location
        </label>
        <input
          formControlName="location"
          type="text"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          placeholder="Enter event location"
        />
      </div>

      <!-- Event Type -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Event Type <span class="text-red-500">*</span>
        </label>
        <select
          formControlName="eventType"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        >
          <option value="meeting">Meeting</option>
          <option value="training">Training</option>
          <option value="event">Event</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- Status -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Status <span class="text-red-500">*</span>
        </label>
        <select
          formControlName="status"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        >
          <option value="draft">Draft</option>
          <option value="published">Published</option>
          <option value="cancelled">Cancelled</option>
          <option value="completed">Completed</option>
        </select>
      </div>

      <!-- Max Attendees -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
          Max Attendees (Optional)
        </label>
        <input
          formControlName="maxAttendees"
          type="number"
          min="1"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          placeholder="Leave empty for unlimited"
        />
      </div>

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-red-800 dark:text-red-200 text-sm">{{ errorMessage() }}</p>
        </div>
      }
    </form>
  </app-modal>

  <!-- Event Details Modal -->
  <app-modal
    [isOpen]="showDetailModal()"
    [title]="'Event Details - ' + (selectedEvent()?.eventName || 'Event')"
    (closed)="closeDetailModal()"
    [config]="{ size: 'xl' }"
  >
    @if (selectedEvent()) {
      <div class="space-y-6">
        <!-- Event Information -->
        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">Event Information</h3>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-gray-600 dark:text-gray-400">Name:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">{{ selectedEvent()?.eventName }}</p>
            </div>
            <div>
              <span class="text-gray-600 dark:text-gray-400">Type:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">{{ selectedEvent()?.eventType || 'other' }}</p>
            </div>
            <div>
              <span class="text-gray-600 dark:text-gray-400">Start Date:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">{{ selectedEvent()?.startDate ? portalService.formatDateTime(selectedEvent()!.startDate) : 'N/A' }}</p>
            </div>
            <div>
              <span class="text-gray-600 dark:text-gray-400">End Date:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">{{ selectedEvent()?.endDate ? portalService.formatDateTime(selectedEvent()!.endDate) : 'N/A' }}</p>
            </div>
            <div class="col-span-2">
              <span class="text-gray-600 dark:text-gray-400">Location:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">{{ selectedEvent()?.location || 'N/A' }}</p>
            </div>
            @if (selectedEvent()?.description) {
              <div class="col-span-2">
                <span class="text-gray-600 dark:text-gray-400">Description:</span>
                <p class="font-medium text-gray-900 dark:text-gray-100 mt-1">{{ selectedEvent()?.description }}</p>
              </div>
            }
            <div>
              <span class="text-gray-600 dark:text-gray-400">Status:</span>
              <p class="font-medium text-gray-900 dark:text-gray-100">
                {{ portalService.getStatusIcon(selectedEvent()?.status || calculateEventStatus(selectedEvent()!)) }} 
                {{ selectedEvent()?.status || calculateEventStatus(selectedEvent()!) }}
              </p>
            </div>
            @if (selectedEvent()?.publicUrl) {
              <div class="col-span-2">
                <span class="text-gray-600 dark:text-gray-400">Public URL:</span>
                <div class="flex items-center gap-2 mt-1">
                  <code class="flex-1 px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm text-gray-900 dark:text-gray-100">
                    {{ window.location.origin }}/events/register/{{ selectedEvent()?.publicUrl }}
                  </code>
                  <app-glass-button (clicked)="copyPublicLink(selectedEvent()!)" variant="secondary" size="sm">
                    üìã Copy
                  </app-glass-button>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Statistics Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Statistics</h3>
            <app-glass-button 
              (clicked)="showStatistics.set(!showStatistics())" 
              variant="secondary" 
              size="sm"
            >
              {{ showStatistics() ? 'Hide' : 'Show' }} Statistics
            </app-glass-button>
          </div>
          
          @if (showStatistics()) {
            @if (statisticsLoading()) {
              <div class="text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto"></div>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Loading statistics...</p>
              </div>
            } @else if (eventStatistics()) {
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg text-center">
                  <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                    {{ eventStatistics()?.total_registrations || eventStatistics()?.totalRegistrations || 0 }}
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Total Registrations</p>
                </div>
                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg text-center">
                  <p class="text-2xl font-bold text-green-600 dark:text-green-400">
                    {{ eventStatistics()?.checked_in || eventStatistics()?.checkedIn || 0 }}
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Checked In</p>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg text-center">
                  <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                    {{ eventStatistics()?.attendance_rate || eventStatistics()?.attendanceRate || 0 }}%
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Attendance Rate</p>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg text-center">
                  <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">
                    {{ eventStatistics()?.confirmed_emails || eventStatistics()?.confirmedEmails || 0 }}
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Confirmed Emails</p>
                </div>
              </div>
            } @else {
              <p class="text-gray-600 dark:text-gray-400 text-center py-4">No statistics available</p>
            }
          }
        </div>

        <!-- Linked Devices Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
              Linked Devices 
              <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                ({{ linkedDevices().length }})
              </span>
            </h3>
            <app-glass-button 
              (clicked)="linkDeviceToEvent(selectedEvent()!)" 
              variant="primary" 
              size="sm"
            >
              ‚ûï Link Device
            </app-glass-button>
          </div>
          
          @if (linkedDevicesLoading()) {
            <div class="text-center py-4">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mx-auto"></div>
            </div>
          } @else if (linkedDevices().length === 0) {
            <p class="text-gray-600 dark:text-gray-400 text-center py-4">No devices linked to this event</p>
          } @else {
            <div class="space-y-2">
              @for (device of linkedDevices(); track device.device_id) {
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                  <div>
                    <p class="font-medium text-gray-900 dark:text-gray-100">{{ device.device_name || device.name }}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      {{ device.location || 'N/A' }} ‚Ä¢ {{ device.device_type || 'N/A' }}
                    </p>
                  </div>
                  <app-glass-button 
                    (clicked)="unlinkDevice(device.device_id)" 
                    variant="danger" 
                    size="sm"
                  >
                    Unlink
                  </app-glass-button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Actions -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 flex gap-2">
          <app-glass-button 
            (clicked)="viewAttendees(selectedEvent()!)" 
            variant="primary"
          >
            üë• View Attendees
          </app-glass-button>
          <app-glass-button 
            (clicked)="editEvent(selectedEvent()!)" 
            variant="secondary"
          >
            ‚úèÔ∏è Edit Event
          </app-glass-button>
          <app-glass-button 
            (clicked)="sendEventReminders()" 
            variant="secondary"
          >
            üìß Send Reminders
          </app-glass-button>
        </div>
      </div>
    }
  </app-modal>

  <!-- Attendees Modal -->
  <app-modal
    [isOpen]="showAttendeesModal()"
    [title]="'Event Attendees - ' + (selectedEvent()?.eventName || 'Event')"
    (closed)="closeAttendeesModal()"
    [config]="{ size: 'xl' }"
  >
    <div class="space-y-4">
      @if (attendeesLoading()) {
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto"></div>
          <p class="mt-2 text-gray-600 dark:text-gray-400">Loading attendees...</p>
        </div>
      } @else if (attendees().length === 0) {
        <div class="text-center py-8">
          <p class="text-gray-600 dark:text-gray-400">No attendees found</p>
        </div>
      } @else {
        <!-- Action Buttons -->
        <div class="flex justify-end gap-2 mb-4">
          <app-glass-button 
            (clicked)="openBulkAddModal()" 
            variant="primary"
            size="sm"
          >
            ‚ûï Bulk Add Attendees
          </app-glass-button>
          <app-glass-button 
            (clicked)="exportAttendeesToCSV(selectedEvent()?.id!)" 
            variant="secondary"
            size="sm"
          >
            üì• Export to CSV
          </app-glass-button>
        </div>

        <!-- Attendees Table -->
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-50 dark:bg-gray-800">
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">Name</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">Email</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">Status</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">Check-in Time</th>
              </tr>
            </thead>
            <tbody>
              @for (attendee of attendees(); track trackByAttendee($index, attendee)) {
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                  <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">
                    {{ attendee.memberFirstName || attendee.firstName || 'N/A' }} 
                    {{ attendee.memberLastName || attendee.lastName || '' }}
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                    {{ attendee.memberEmail || attendee.email || 'N/A' }}
                  </td>
                  <td class="px-4 py-2 text-sm border-b border-gray-200 dark:border-gray-700">
                    <span class="px-2 py-1 rounded text-xs font-medium"
                      [class.bg-green-100]="attendee.status === 'CHECKED_IN'"
                      [class.text-green-800]="attendee.status === 'CHECKED_IN'"
                      [class.bg-yellow-100]="attendee.status === 'REGISTERED'"
                      [class.text-yellow-800]="attendee.status === 'REGISTERED'"
                      [class.dark:bg-green-900/20]="attendee.status === 'CHECKED_IN'"
                      [class.dark:text-green-400]="attendee.status === 'CHECKED_IN'"
                      [class.dark:bg-yellow-900/20]="attendee.status === 'REGISTERED'"
                      [class.dark:text-yellow-400]="attendee.status === 'REGISTERED'">
                      {{ attendee.status || 'REGISTERED' }}
                    </span>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                    {{ attendee.checkInTime ? portalService.formatDateTime(attendee.checkInTime) : 'Not checked in' }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (getTotalPages() > 1) {
          <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Showing {{ (attendeesPage() - 1) * pageSize + 1 }} - 
              {{ attendeesPage() * pageSize > attendeesTotal() ? attendeesTotal() : attendeesPage() * pageSize }} 
              of {{ attendeesTotal() }} attendees
            </div>
            <div class="flex items-center gap-2">
              <app-glass-button 
                [disabled]="attendeesPage() === 1" 
                (clicked)="loadAttendees(selectedEvent()?.id!, attendeesPage() - 1)"
                variant="secondary"
                size="sm"
              >
                ‚Üê Previous
              </app-glass-button>
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                Page {{ attendeesPage() }} of {{ getTotalPages() }}
              </span>
              <app-glass-button 
                [disabled]="attendeesPage() >= getTotalPages()" 
                (clicked)="loadAttendees(selectedEvent()?.id!, attendeesPage() + 1)"
                variant="secondary"
                size="sm"
              >
                Next ‚Üí
              </app-glass-button>
            </div>
          </div>
        }
      }
    </div>
  </app-modal>

  <!-- Link Device Modal -->
  <app-modal
    [isOpen]="showLinkDeviceModal()"
    [title]="'Link Device to Event - ' + (linkingEvent()?.eventName || 'Event')"
    [loading]="linkingDevice()"
    (closed)="closeLinkDeviceModal()"
    (confirmed)="confirmLinkDevice()"
  >
    <div class="space-y-4">
      @if (availableDevices().length === 0) {
        <div class="text-center py-8">
          <p class="text-gray-600 dark:text-gray-400">No devices available</p>
        </div>
      } @else {
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
            Select Device <span class="text-red-500">*</span>
          </label>
          <select
            [(ngModel)]="selectedDeviceId"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          >
            <option value="">-- Select a device --</option>
            @for (device of availableDevices(); track trackByDevice($index, device)) {
              <option [value]="device.device_id || device.id">
                {{ device.device_name || device.name }} 
                ({{ device.location || 'N/A' }})
              </option>
            }
          </select>
        </div>

        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
          <p class="text-sm text-blue-800 dark:text-blue-200">
            ‚ÑπÔ∏è This device will be used for event check-in. Make sure the device is properly configured.
          </p>
        </div>
      }
    </div>
  </app-modal>

  <!-- Bulk Add Attendees Modal -->
  <app-modal
    [isOpen]="showBulkAddModal()"
    title="Bulk Add Attendees"
    (closed)="closeBulkAddModal()"
    [config]="{ size: 'xl' }"
  >
    <div class="space-y-4">
      <!-- Mode Selection -->
      <div class="flex gap-2 mb-4">
        <app-glass-button
          (clicked)="bulkAddMode.set('select')"
          [variant]="bulkAddMode() === 'select' ? 'primary' : 'secondary'"
          size="sm"
        >
          Select Members
        </app-glass-button>
        <app-glass-button
          (clicked)="bulkAddMode.set('csv')"
          [variant]="bulkAddMode() === 'csv' ? 'primary' : 'secondary'"
          size="sm"
        >
          Upload CSV
        </app-glass-button>
      </div>

      <!-- Select Members Mode -->
      @if (bulkAddMode() === 'select') {
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Select members to add as attendees
            </p>
            <div class="flex gap-2">
              <app-glass-button (clicked)="selectAllMembers()" variant="secondary" size="sm">
                Select All
              </app-glass-button>
              <app-glass-button (clicked)="deselectAllMembers()" variant="secondary" size="sm">
                Deselect All
              </app-glass-button>
            </div>
          </div>

          @if (membersLoading()) {
            <div class="text-center py-8">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto"></div>
              <p class="mt-2 text-gray-600 dark:text-gray-400">Loading members...</p>
            </div>
          } @else if (availableMembers().length === 0) {
            <div class="text-center py-8">
              <p class="text-gray-600 dark:text-gray-400">No members available</p>
            </div>
          } @else {
            <div class="max-h-96 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg">
              <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0">
                  <tr>
                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                      <input
                        type="checkbox"
                        [checked]="selectedMemberIds().length === availableMembers().length && availableMembers().length > 0"
                        (change)="selectedMemberIds().length === availableMembers().length ? deselectAllMembers() : selectAllMembers()"
                        class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                      />
                    </th>
                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Name</th>
                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Email</th>
                  </tr>
                </thead>
                <tbody>
                  @for (member of availableMembers(); track trackByMember($index, member)) {
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                      <td class="px-4 py-2">
                        <input
                          type="checkbox"
                          [checked]="isMemberSelected(member.memberId)"
                          (change)="toggleMemberSelection(member.memberId)"
                          class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                        />
                      </td>
                      <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100">
                        {{ member.firstName }} {{ member.lastName }}
                      </td>
                      <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">
                        {{ member.email }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Selected: {{ selectedMemberIds().length }} member(s)
            </p>
          }
        </div>
      }

      <!-- CSV Upload Mode -->
      @if (bulkAddMode() === 'csv') {
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
              Upload CSV File <span class="text-red-500">*</span>
            </label>
            <input
              type="file"
              accept=".csv"
              (change)="onCsvFileSelected($event)"
              class="block w-full text-sm text-gray-500 dark:text-gray-400
                     file:mr-4 file:py-2 file:px-4
                     file:rounded-lg file:border-0
                     file:text-sm file:font-semibold
                     file:bg-primary-50 file:text-primary-700
                     hover:file:bg-primary-100
                     dark:file:bg-primary-900/20 dark:file:text-primary-300"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              CSV format: email, firstName, lastName (header row required)
            </p>
          </div>

          @if (csvPreview().length > 0) {
            <div>
              <p class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Preview (first 10 rows):</p>
              <div class="max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-gray-100">Email</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-gray-100">First Name</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-gray-100">Last Name</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of csvPreview(); track trackByCsvRow($index, row)) {
                      <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                        <td class="px-3 py-1 text-gray-900 dark:text-gray-100">{{ row.email }}</td>
                        <td class="px-3 py-1 text-gray-600 dark:text-gray-400">{{ row.firstName }}</td>
                        <td class="px-3 py-1 text-gray-600 dark:text-gray-400">{{ row.lastName }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
        </div>
      }

      <!-- Action Buttons -->
      <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
        <app-glass-button
          (clicked)="closeBulkAddModal()"
          variant="secondary"
          [disabled]="bulkAdding()"
        >
          Cancel
        </app-glass-button>
        <app-glass-button
          (clicked)="bulkAddAttendees()"
          variant="primary"
          [disabled]="bulkAdding() || (bulkAddMode() === 'select' && selectedMemberIds().length === 0) || (bulkAddMode() === 'csv' && !csvFile())"
        >
          @if (bulkAdding()) {
            Adding...
          } @else {
            Add Attendees
          }
        </app-glass-button>
      </div>
    </div>
  </app-modal>
</app-page-layout>
